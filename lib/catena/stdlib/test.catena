-- Catena Testing Framework
-- Provides unit tests, property-based tests, and law verification
--
-- This replaces the 'test' and 'property' keywords with library functions.
-- Tests are first-class values that can be composed and organized.

module Test

export type Test
export type Property
export type TestResult
export type Suite

export transform unit
export transform property
export transform assert
export transform assertEqual
export transform assertMatch
export transform verify
export transform suite
export transform run
export transform benchmark

-- Test result types
type TestResult =
  | Passed
  | Failed String
  | Skipped String

type Test = Test {
  name : String,
  run : Unit -> TestResult
}

type Property = Property {
  name : String,
  check : Natural -> TestResult
}

type Suite = Suite {
  name : String,
  tests : List Test
}

-- Create a unit test
transform unit : String -> (Unit -> Bool) -> Test
transform unit name testFn = Test {
  name = name,
  run = fn () -> match testFn ()
    | true -> Passed
    | false -> Failed "Assertion failed"
  end
}

-- Create a property-based test
transform property : String -> (a -> Bool) -> Property
transform property name prop = Property {
  name = name,
  check = fn numTests ->
    -- Property testing would generate random values
    -- For now, return passed (actual implementation needs generators)
    Passed
}

-- Basic assertions
transform assert : Bool -> TestResult
transform assert cond = match cond
  | true -> Passed
  | false -> Failed "Assertion failed"
end

transform assertEqual : Comparable a => a -> a -> TestResult
transform assertEqual expected actual = match equals expected actual
  | true -> Passed
  | false -> Failed "Values not equal"
end

transform assertMatch : (a -> Bool) -> a -> TestResult
transform assertMatch pred value = match pred value
  | true -> Passed
  | false -> Failed "Pattern match failed"
end

-- Verify that a type satisfies trait laws
transform verify : String -> (Unit -> Bool) -> Test
transform verify lawName check = Test {
  name = lawName,
  run = fn () -> match check ()
    | true -> Passed
    | false -> Failed "Law verification failed"
  end
}

-- Create a test suite
transform suite : String -> List Test -> Suite
transform suite name tests = Suite {
  name = name,
  tests = tests
}

-- Run a test and get result
transform run : Test -> TestResult
transform run test = test.run ()

-- Benchmark type and function
type Benchmark = Benchmark {
  name : String,
  iterations : Natural,
  run : Unit -> Unit
}

transform benchmark : String -> Natural -> (Unit -> Unit) -> Benchmark
transform benchmark name iterations fn = Benchmark {
  name = name,
  iterations = iterations,
  run = fn
}

-- Example usage:
--
-- myTests = suite "Math Tests" [
--   unit "addition" (fn () -> 1 + 1 === 2),
--   unit "multiplication" (fn () -> 2 * 3 === 6),
--   verify "Accumulator identity" (fn () ->
--     let empty = 0
--     let x = 5
--     combine empty x === x
--   )
-- ]
--
-- myProps = [
--   property "addition commutative" (fn x y -> x + y === y + x),
--   property "list reverse involutive" (fn xs -> reverse (reverse xs) === xs)
-- ]
